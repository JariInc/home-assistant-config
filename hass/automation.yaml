- id: heating_update_thermostats
  alias: Heating Update Thermostats
  initial_state: true
  trigger:
    platform: state
    entity_id:
      - sensor.thermofloor_as_heatit_thermostat_tf_033_external_sensor
  action:
    service: python_script.heating_thermostat_update
    data:
      thermostat: climate.thermofloor_as_heatit_thermostat_tf_033_heating
      sensor: sensor.thermofloor_as_heatit_thermostat_tf_033_external_sensor

- id: disable_car_heater_side
  alias: Disable side car heater
  initial_state: true
  trigger:
    platform: numeric_state
    entity_id: sensor.garage_side_socket_power
    above: -1
    below: 1
    for:
      minutes: 10
  action:
    - service: switch.turn_off
      entity_id: switch.car_heater_side
    - service: input_boolean.turn_off
      entity_id: input_boolean.car_heater_side_armed

- id: disable_car_heater_front
  alias: Disable front cat heater
  initial_state: true
  trigger:
    platform: numeric_state
    entity_id: sensor.garage_front_socket_power
    above: -1
    below: 1
    for:
      minutes: 10
  action:
    - service: switch.turn_off
      entity_id: switch.car_heater_front
    - service: input_boolean.turn_off
      entity_id: input_boolean.car_heater_front_armed

- id: alert_heatpump
  alias: Heat pump cold draft prevention function alert
  initial_state: true
  trigger:
  - platform: numeric_state
    entity_id: sensor.heatpump_set_temperature
    above: 25
  action:
  - service: notify.push_notify
    data:
      title: "Ilmalämpöpumppuhälytys"
      message: "Asetuslämpötila yli 25 astetta"

- id: front_door_light_on
  alias: Front door light on
  initial_state: true
  trigger:
    platform: state
    entity_id: binary_sensor.0xd0cf5efffe124b79_occupancy
    from: 'off'
    to: 'on'
  condition:
    condition: or
    conditions:
      - condition: sun
        after: sunset
      - condition: sun
        before: sunrise
  action:
    service: light.turn_on
    data:
      entity_id:
        - light.0x90fd9ffffeff2e13_light

- id: front_door_light_off
  alias: Front door light off
  initial_state: true
  trigger:
    platform: state
    entity_id: binary_sensor.0xd0cf5efffe124b79_occupancy
    from: 'on'
    to: 'off'
  action:
    service: light.turn_off
    data:
      entity_id:
        - light.0x90fd9ffffeff2e13_light

- id: shower_room_ledstript_on
  alias: Shower room LED strip on
  initial_state: true
  trigger:
    platform: state
    entity_id: binary_sensor.shelly1_25abb7
    from: 'off'
    to: 'on'
  action:
    service: light.turn_on
    data:
      entity_id: light.shower_room_led_strip
      #brightness_pct: 50

- id: shower_room_ledstrip_off
  alias: Shower room LED strip off
  initial_state: true
  trigger:
    platform: state
    entity_id: binary_sensor.shelly1_25abb7
    from: 'on'
    to: 'off'
  action:
    service: light.turn_off
    data:
      entity_id: light.shower_room_led_strip

- id: shower_room_downlight_on
  alias: Shower room downlight on
  initial_state: true
  trigger:
    platform: state
    entity_id: binary_sensor.shelly1_25a447
    from: 'off'
    to: 'on'
  action:
    - service: light.turn_on
      data:
        entity_id: light.shower_room_downlight

- id: shower_room_downlight_off
  alias: Shower room downlight off
  initial_state: true
  trigger:
    platform: state
    entity_id: binary_sensor.shelly1_25a447
    from: 'on'
    to: 'off'
  action:
    - service: light.turn_off
      data:
        entity_id: light.shower_room_downlight

- id: occupancy_change
  alias: Occupancy changed
  trigger:
    - platform: state
      entity_id: input_select.occupancy_state
  action:
    - service: mqtt.publish
      data_template:
        topic: 'hvac/toshiba-63200289/occupancy_state'
        retain: true
        payload: "{{ states('input_select.occupancy_state') }}"

- id: occupancy_home
  alias: Occupancy at home
  trigger:
    platform: state
    entity_id: input_select.occupancy_state
    to: 'home'
  action:
    - service: switch.turn_on
      entity_id: switch.0x000d6ffffee3cb28_switch

- id: occupancy_away
  alias: Occupancy away
  trigger:
    platform: state
    entity_id: input_select.occupancy_state
    to: 'away'
  action:
    - service: switch.turn_off
      entity_id: switch.0x000d6ffffee3cb28_switch

# - id: occupancy_sleep
#   alias: Occupancy sleeping
#   trigger:
#     platform: state
#     entity_id: input_select.occupancy_state
#     to: 'sleep'
#   action:

- id: occupancy_button
  alias: Occupancy button
  trigger:
    platform: mqtt
    topic: zigbee2mqtt/xiaomi_agara_double_button_1
  # condition:
  #   condition: template
  #   value_template: "{{ 'left' == trigger.payload_json.click }}"
  action:
    - service: input_select.select_option
      # data:
      #   entity_id: input_select.occupancy_state
      #   option: 'home'
      data_template:
        entity_id: input_select.occupancy_state
        option: >
          {% if 'left' == trigger.payload_json.click %}
            home
          {% elif 'right' == trigger.payload_json.click %}
            away
          {% endif %}

# - id: occupancy_button_home
#   alias: "Set occupancy to home"
#   trigger:
#     platform: mqtt
#     topic: zigbee2mqtt/xiaomi_agara_double_button_1
#   condition:
#     condition: template
#     value_template: "{{ 'left' == trigger.payload_json.click }}"
#   action:
#     service: input_select.select_option
#     data:
#       entity_id: input_select.occupancy_state
#       option: 'home'

# - id: occupancy_button_away
#   alias: "Set occupancy to away"
#   trigger:
#     platform: mqtt
#     topic: zigbee2mqtt/xiaomi_agara_double_button_1
#   condition:
#     condition: template
#     value_template: "{{ 'right' == trigger.payload_json.click }}"
#   action:
#     service: input_select.select_option
#     data:
#       entity_id: input_select.occupancy_state
#       option: 'away'

- id: occupancy_timed_sleep
  alias: "Set occupancy to sleep"
  trigger:
    platform: time
    at: "22:00:00"
  condition:
    condition: state
    entity_id: input_select.occupancy_state
    state: 'home'
  action:
    service: input_select.select_option
    data:
      entity_id: input_select.occupancy_state
      option: 'sleep'

- id: occupancy_timed_home
  alias: "Set occupancy to home if in sleep"
  trigger:
    platform: time
    at: "06:00:00"
  condition:
    condition: state
    entity_id: input_select.occupancy_state
    state: 'sleep'
  action:
    service: input_select.select_option
    data:
      entity_id: input_select.occupancy_state
      option: 'home'

- id: shower_room_drying_on
  alias: "Dry shower room"
  trigger:
    - platform: numeric_state
      entity_id: sensor.shower_room_moisture
      above: 25
  action:
    - service: climate.set_temperature
      data:
        entity_id: climate.thermofloor_as_heatit_thermostat_tf_033_heating
        temperature: 25

- id: shower_room_drying_off
  alias: "Don't dry shower room"
  trigger:
    - platform: state
      entity_id: input_select.occupancy_state
    - platform: numeric_state
      entity_id: sensor.shower_room_moisture
      below: 25
      for:
        minutes: 15
  condition:
    - condition: numeric_state
      entity_id: sensor.shower_room_moisture
      below: 25
  action:
    - service: climate.set_temperature
      data_template:
        entity_id: climate.thermofloor_as_heatit_thermostat_tf_033_heating
        temperature: >
          {% if is_state('input_select.occupancy_state', 'home') %}
            20
          {% else %}
            17
          {% endif %}
